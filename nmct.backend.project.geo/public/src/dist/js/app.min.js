function showErrorMsg(){jQuery(this).attr("data-popup-open");$('[data-popup="popup-1"]').fadeIn(350),$("#wrapper").toggleClass("toggled"),$("[data-popup-close]").on("click",function(e){var t=jQuery(this).attr("data-popup-close");$('[data-popup="'+t+'"]').fadeOut(350)})}function showPosition(e){var t=e.coords.latitude,a=e.coords.longitude,n={lat:t,lng:a};placeMarkerAndPanTo(n,map)}function placeMarkerAndPanTo(e,t){var a=new google.maps.Marker({position:e,map:t,draggable:!0});t.panTo(e);var n='<h1 class="iw-title">Your location!!</h1>',o=new google.maps.InfoWindow({content:n});a.addListener("click",function(){o.open(t,a)})}function showError(e){switch(e.code){case e.PERMISSION_DENIED:showErrorMsg();break;case e.POSITION_UNAVAILABLE:showErrorMsg();break;case e.TIMEOUT:showErrorMsg();break;case e.UNKNOWN_ERROR:showErrorMsg()}}var chat=function(){function e(e,a){if(void 0!==a&&null===document.getElementById(a)){var n=document.createElement("li"),o=document.createElement("div");o.setAttribute("class","chat-status"),n.appendChild(o),n.appendChild(document.createTextNode(a)),n.id=a,n.setAttribute("class","list-group-item online-users");var r=document.getElementById("users");r.appendChild(n),i[a]={currentUser:[],chatPartner:[]},t()}}function t(){var e=document.getElementsByClassName("online-users"),t=document.getElementsByClassName("sent-message")[0],n=document.getElementsByClassName("received-message")[0],o=document.getElementById("btn-send"),i=document.getElementById("selected-user");(""===chat.selectedUser||"undefined"==typeof chat.selectedUser||null===chat.selectedUser)&&o.setAttribute("disabled",!0);for(var r=0,s=e.length;s>r;r++){var l=r;!function(r){e[r].addEventListener("click",function(){chat.selectedUser=e[r].id,$(this).parent().children().removeClass("active"),$(this).addClass("active"),o.removeAttribute("disabled"),t.innerHTML="",n.innerHTML="",a(chat.selectedUser),i.innerHTML=e[r].id})}(l)}}function a(e){var t=document.getElementsByClassName("sent-message")[0],a=document.getElementsByClassName("received-message")[0];t.innerHTML="",a.innerHTML="";for(var n=0,o=i[e].currentUser.length;o>n;n++){var r=document.createElement("div");r.setAttribute("class","sent-message-box"),r.innerHTML=i[e].currentUser[n],t.appendChild(r)}for(var n=0,o=i[e].chatPartner.length;o>n;n++){var r=document.createElement("div");r.setAttribute("class","received-message-box"),r.innerHTML=i[e].chatPartner[n],a.appendChild(r)}}function n(e,t){document.getElementById(t).remove()}var o,i=[];return{addUser:e,deleteUser:n,selectedUser:o,messages:i,addMessageToChat:a}}(),Sha1={};Sha1.hash=function(e){e=e.utf8Encode();var t=[1518500249,1859775393,2400959708,3395469782];e+=String.fromCharCode(128);for(var a=e.length/4+2,n=Math.ceil(a/16),o=new Array(n),i=0;n>i;i++){o[i]=new Array(16);for(var r=0;16>r;r++)o[i][r]=e.charCodeAt(64*i+4*r)<<24|e.charCodeAt(64*i+4*r+1)<<16|e.charCodeAt(64*i+4*r+2)<<8|e.charCodeAt(64*i+4*r+3)}o[n-1][14]=8*(e.length-1)/Math.pow(2,32),o[n-1][14]=Math.floor(o[n-1][14]),o[n-1][15]=8*(e.length-1)&4294967295;for(var s,l,c,d,g,u=1732584193,p=4023233417,m=2562383102,h=271733878,f=3285377520,v=new Array(80),i=0;n>i;i++){for(var y=0;16>y;y++)v[y]=o[i][y];for(var y=16;80>y;y++)v[y]=Sha1.ROTL(v[y-3]^v[y-8]^v[y-14]^v[y-16],1);s=u,l=p,c=m,d=h,g=f;for(var y=0;80>y;y++){var b=Math.floor(y/20),S=Sha1.ROTL(s,5)+Sha1.f(b,l,c,d)+g+t[b]+v[y]&4294967295;g=d,d=c,c=Sha1.ROTL(l,30),l=s,s=S}u=u+s&4294967295,p=p+l&4294967295,m=m+c&4294967295,h=h+d&4294967295,f=f+g&4294967295}return Sha1.toHexStr(u)+Sha1.toHexStr(p)+Sha1.toHexStr(m)+Sha1.toHexStr(h)+Sha1.toHexStr(f)},Sha1.f=function(e,t,a,n){switch(e){case 0:return t&a^~t&n;case 1:return t^a^n;case 2:return t&a^t&n^a&n;case 3:return t^a^n}},Sha1.ROTL=function(e,t){return e<<t|e>>>32-t},Sha1.toHexStr=function(e){for(var t,a="",n=7;n>=0;n--)t=e>>>4*n&15,a+=t.toString(16);return a},"undefined"==typeof String.prototype.utf8Encode&&(String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this))}),"undefined"==typeof String.prototype.utf8Decode&&(String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this))}catch(e){return this}}),"undefined"!=typeof module&&module.exports&&(module.exports=Sha1),"function"==typeof define&&define.amd&&define([],function(){return Sha1});var client=function(){"use-strict";var e,t,a,n=function(a){void 0!==t&&t.disconnect(),t=io.connect(e?"?token="+e:"",{forceNew:!0}),t.on("time",function(e){console.log("- broadcast: "+e)}).on("register",function(e){console.log("- register")}).on("authenticated",function(){console.log("- authenticated")}).on("disconnect",function(){console.log("- disconnected")}).on("unauthorized",function(e){console.log("- unauthorized")}).on("addshare",function(e){createMap.addShareToMap(null,e)}).on("addactivity",function(e){createMap.addActivityToMap(null,e)}).on("deleteactivity",function(e){createMap.deleteActivityFromMap(null,e)}).on("newuser",function(e){localStorage.isAvailable&&(chat.addUser(null,e),console.log("- new user: "+e))}).on("users",function(e){if(localStorage.isAvailable)for(var t=0,a=e.length;a>t;t++)chat.addUser(null,e[t])}).on("deleteuser",function(e){localStorage.isAvailable&&(chat.deleteUser(null,e.username),console.log("- delete user: "+e.username))}).on("message",function(e){chat.messages[e.username].chatPartner.push(e.message),chat.addMessageToChat(e.username),console.log("- message: "+e.message)}).on("challenge",function(e){console.log(e)}).on("error",function(e){console.log("- Socket error: "+e)}),client.isAdmin=a.isAdmin,a.isAvailable&&(t.emit("newuser",a),t.emit("users",null))},o=function(e){i("anonymous",Sha1.hash("123"),e)},i=function(t,a,o){$.ajax({type:"POST",contentType:"text/html; charset=UTF-8",data:{username:t,password:a},url:"../login"}).done(function(t){t.error?o(t.error,null):t.token?(e=t.token,localStorage.token=e,localStorage.isAvailable=t.user.isAvailable,localStorage.hash=t.user.password,localStorage.username=t.user.username,n(t.user),o(null,t.user)):o("Unhandeld error",null)})},r=function(e,t,a){i(e,Sha1.hash(t.toString()),a)},s=function(e,t,a){i(e,t,a)};return register=function(a,n,o,i,r,s){var l={id:o,name:a,firstname:n,username:o,password:Sha1.hash(i+""),isAvailable:r};null===l.id||""===l.id?s("Error: 'id' is missing",null):(t.emit("register",{error:null,user:l,token:null===e?localStorage.token:e}),s(null,l))},getAllGeneric=function(e,a){t.on(e,function(t){t?a(null,t):a("no "+e+" found",null)}),t.emit(e,null)},addShare=function(a,n){if("anonymous"===localStorage.username)n("Unauthorized",null);else{var o={error:null,share:a,token:null===e?localStorage.token:e};null===a.id||""===a.id?n("Error: 'id' is missing",null):(t.emit("addshare",o),n(null,o))}},addActivity=function(a,n){if("anonymous"===localStorage.username)n("Unauthorized",null);else{var o={error:null,activity:a,token:null===e?localStorage.token:e};null===a.id||""===a.id?n("Error: 'id' is missing",null):(t.emit("addactivity",o),n(null,o))}},sendMessage=function(e,a,n){t.emit("message",{message:e,username:a}),n(null,"message send")},deleteActivity=function(a,n){a?(t.emit("deleteactivity",{error:null,activityId:a,token:null===e?localStorage.token:e}),n(null,a)):n("no 'id' found in activityId",null)},{login:r,rememberMeLogin:s,register:register,connectAnonymous:o,getAllGeneric:getAllGeneric,addShare:addShare,addActivity:addActivity,deleteActivity:deleteActivity,sendMessage:sendMessage,isAdmin:a}}(),markers=[],contentString="",previousShareId="",map,createMap=function(){function e(e,t,a){contentString='<div id="iw-container" class="container"><div class="row"><h1 class="iw-title">'+e.activityName+'</h1><div class="col-sm-5 col-xs-4"><div class="list-group"><button id="btn'+e.id+'_happy" value="happy" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/happy@xs.png" alt="happy"><span class="feeling-text">Happy </span> <span class="badge share-count" id="badge_'+e.id+'_happy">'+a.happy+'</span></button><button id="btn'+e.id+'_excited" value="excited" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/excited@xs.png" alt="excited"><span class="feeling-text">Excited</span> <span class="badge share-count" id="badge_'+e.id+'_excited">'+a.excited+'</span></button><button id="btn'+e.id+'_tender" value="tender" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/tender@xs.png" alt="tender"><span class="feeling-text">Tender</span><span class="badge share-count" id="badge_'+e.id+'_tender">'+a.tender+'</span></button></div></div><div class="col-sm-5 col-xs-4"><div class="list-group feelings-right"><button id="btn'+e.id+'_scared" value="scared" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/scared@xs.png" alt="scared"><span class="feeling-text">Scared</span><span class="badge share-count" id="badge_'+e.id+'_scared">'+a.scared+'</span></button><button id="btn'+e.id+'_sad" value="sad" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/sad@xs.png" alt="sad"><span class="feeling-text">Sad</span><span class="badge share-count" id="badge_'+e.id+'_sad">'+a.sad+'</span></button><button id="btn'+e.id+'_angry" value="angry" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/angry@xs.png" alt="angry"><span class="feeling-text">Angry</span><span class="badge share-count" id="badge_'+e.id+'_angry">'+a.angry+'</span></button></div></div></div><div class="alert alert-success alert-dismissable " id="feedback" role="alert"><span id="feedback-msg"></span><button class="close-alert">&times;</button></div><button ng-show="isAdmin" style="display:none;" id="btnDelete_'+e.id+'" class="btn btn-danger" >Delete</button></div>';var n=new google.maps.InfoWindow({content:contentString});t.addListener("click",function(){n.open(map,t)}),google.maps.event.addListener(n,"domready",function(){for(var t=["happy","excited","tender","sad","scared","angry"],a=0,n=t.length;n>a;a++)!function(a){document.getElementById("btn"+e.id+"_"+t[a]).addEventListener("click",function(n){c(t[a],e)})}(a);var o=document.querySelector('button[id^="btnDelete_'+e.id+'"]');o.style.display=client.isAdmin?"block":"none",document.getElementById("btnDelete_"+e.id).addEventListener("click",function(t){client.deleteActivity(e.id,function(e,t){console.log("delete activity")})}),l(localStorage.username,e.id,function(e,t){e&&console.log(e)})})}var t=function(e){var t=document.getElementById(e),a={center:{lat:50.824683,lng:3.25141},zoom:8,mapTypeControl:!1,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(t,a)},a=function(){client.connectAnonymous(function(e,t){e?console.log(e):n()})},n=function(){client.getAllGeneric("signedshares",function(e,t){e&&console.log(e);for(var a=0,n=t.length;n>a;a++){var o=t[a],i=o.activityId+"";void 0===allSignedShares[i]&&(allSignedShares[i]=[]),allSignedShares[i].push(o)}client.getAllGeneric("activities",function(e,t){if(e)console.log(e);else for(var a=0,n=t.length;n>a;a++)r(null,t[a])})}),client.getAllGeneric("unsignedshares",function(e,t){e&&console.log(e);for(var a=0,n=t.length;n>a;a++){var o=t[a].author;void 0===allUnsignedShares[o]&&(allUnsignedShares[o]=[]),allUnsignedShares[o].push(t[a])}for(var a=0,n=t.length;n>a;a++)i(null,t[a])})},o=function(e,t){if(0==t.activityId)i(e,t);else if(t.id!==previousShareId){previousShareId=t.id;var a=(markers[t.activityId],document.getElementById("badge_"+t.activityId+"_"+t.feeling)),n=parseInt(a.innerHTML);a.innerHTML=isNaN(n)||0===n?1:++n}},i=function(e,t){var a=new google.maps.Marker({position:{lat:t.latitude,lng:t.longitude},icon:"../images/"+t.feeling+"-pin.png",map:map}),n=allUnsignedShares[t.author],o='<div id="iw-container" class="container"><div class="row"><h1 class="iw-title">'+t.author+'</h1><canvas id="feelings-chart"></canvas></div></div>',i=new google.maps.InfoWindow({content:o}),r={happy:0,sad:0,excited:0,tender:0,angry:0,scared:0};if(void 0!==n)for(var s=0,l=n.length;l>s;s++)r[n[s].feeling]++;var c={labels:["Happy","Excited","Tender","Scared","Sad","Angry"],datasets:[{label:"Feelings",fillColor:"rgba(220,220,220,0.2)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:[r.happy,r.excited,r.tender,r.scared,r.sad,r.angry]}]};a.addListener("click",function(){i.open(map,a);var e=document.getElementById("feelings-chart").getContext("2d");new Chart(e).Line(c)})},r=function(t,a){var n=new google.maps.Marker({position:{lat:a.latitude,lng:a.longitude},icon:"../images/activity_pin@xs.png",map:map});n.set("id",a.id),markers[a.id]=n;var o={happy:0,sad:0,excited:0,tender:0,angry:0,scared:0},i=allSignedShares[a.id];if(void 0!==i)for(var r=0,s=i.length;s>r;r++)o[i[r].feeling]++;e(a,n,o)},s=function(e,t){e&&console.log(e);var a=markers[t];a.setMap(null)},l=function(e,t,a){var n=allSignedShares[t];if(void 0===n||n.length<=0)a("No shares found",null);else{for(var o=0,i=n.length;i>o&&n[o].author!==e;o++);a(null,n[o])}},c=function(e,t){var a=t.id;l(localStorage.username,a,function(t,n){function o(t){i=t.coords.latitude,r=t.coords.longitude,shareModel.id=(new Date).getTime()+"-"+localStorage.username,shareModel.feeling=e,shareModel.latitude=i,shareModel.longitude=r,shareModel.timestamp=(new Date).toLocaleDateString(),shareModel.author=localStorage.username,shareModel.activityId=a,client.addShare(shareModel,function(e,t){var a=$("#iw-container"),n=$("#feedback"),o=$("#feedback-msg");a.animate({height:237},500),n.css("display","block");var i=$(".close-alert");e?(console.log(e),n.addClass("share-failed"),o.html("An error occured!"),$(".share-failed").animate({opacity:1},750),i.click(function(){$(".share-failed").animate({opacity:0},750),a.animate({height:205},500)})):(console.log("share added"),n.removeClass("share-failed"),n.addClass(" share-success"),o.html("Thanks for sharing!"),$(".share-success").animate({opacity:1},750),i.click(function(){$(".share-success").animate({opacity:0},750),a.animate({height:205},500)}))})}if(t&&console.log(t),null===n||void 0===n){var i,r;navigator.geolocation.getCurrentPosition(o,showError)}else{var s=$("#iw-container"),l=$("#feedback"),c=$("#feedback-msg"),d=$(".close-alert");s.animate({height:237},500),l.css("display","block"),console.log(t),l.addClass("share-failed"),c.html("An error occured!"),$(".share-failed").animate({opacity:1},750),d.click(function(){$(".share-failed").animate({opacity:0},750),s.animate({height:205},500)})}})};return{initialize:t,addShareToMap:o,addUnsignedShareToMap:i,addActivityToMap:r,deleteActivityFromMap:s,getData:a,getUserSharesForActivity:l}}(),mapType=function(){"use strict";return{changeMapType:function(e){switch(e){case"hybrid":map.setMapTypeId(google.maps.MapTypeId.HYBRID);break;case"roadmap":map.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case"satellite":map.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case"terrain":map.setMapTypeId(google.maps.MapTypeId.TERRAIN);break;default:map.setMapTypeId(google.maps.MapTypeId.ROADMAP)}}}}(),activityModel={id:"",activityName:"",author:"",feeling:"",latitude:"",longitude:"",timestamp:""},shareModel={id:"",ShareName:"",author:"",feeling:"",latitude:"",longitude:"",timestamp:"",activityId:""},allSignedShares=[[]],allUnsignedShares=[];!function(){google.maps.event.addDomListener(window,"load",createMap.initialize("map-canvas")),google.maps.event.addDomListener(window,"resize",function(){var e=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(e)});var e=angular.module("app",["ngRoute","ngCookies"]);e.config(["$logProvider","$routeProvider",function(e,t){e.debugEnabled(!0),t.when("/",{controller:"LoginController",controllerAs:"login",templateUrl:"./templates/login.html"}).when("/register",{controller:"RegisterController",controllerAs:"register",templateUrl:"./templates/register.html"}).when("/main",{controller:"MainController",controllerAs:"main",templateUrl:"./templates/main.html",resolve:{addUsers:function(){}}}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$cookies",function(e,t,a){e.$on("$routeChangeStart",function(a,n,o){e.loggedInUser||"./templates/main.html"===n.templateUrl&&t.path("/")})}]),createMap.getData()}(),function(){var e=angular.module("app"),t=function(e,t,a,n){e.isAdmin=void 0!==localStorage.isAmin&&localStorage.isAdmin?!0:!1,e.userLogin=function(){a.loggedInUser=null,client.login(e.username,e.password,function(t,o){t?console.log(t):(n.put("user",e.username),a.loggedInUser=e.username,localStorage.username=e.username,location.href="/#/main")})}};e.controller("LoginController",["$scope","$location","$rootScope","$cookies",t])}(),function(){var e=angular.module("app"),t=function(e,t,a,n){for(var o=["happy","excited","tender","sad","scared","angry"],i=0,r=o.length;r>i;i++)!function(t){$("#"+o[t]).bind("click",function(a){o[t]==e.feeling?$("#"+e.feeling).addClass("active"):$("#"+e.feeling).removeClass("active")})}(i);localStorage.isAvailable||(document.getElementById("chat").innerHTML='<div class="container"><div class="row"><h2 class="headline">No chatbox available</h2></div></div>'),e.addActivityDb=function(){function a(a){o=a.coords.latitude,i=a.coords.longitude,e.activityName?(activityModel.id=(new Date).getTime()+"-"+n.get("user"),activityModel.activityName=e.activityName,activityModel.feeling=e.feeling,activityModel.latitude=o,activityModel.longitude=i,activityModel.timestamp=(new Date).toLocaleDateString(),activityModel.author=n.get("user"),client.addActivity(activityModel,function(e,t){if(e){var a=$("#activity-feedback");a.addClass("error-msg"),a.html("Something went wrong! Please try again later"),a.animate({opacity:1},500),a.css("display","block"),$("html").click(function(){a.css("display","none")}),$("#activity").val("")}else{console.log("activity added");var a=$("#activity-feedback");a.removeClass("error-msg"),a.addClass("success-msg"),a.html("Thanks for sharing!"),a.animate({opacity:1},500),a.css("display","block"),$("html").click(function(){a.css("display","none")}),$("#activity").val("")}})):(shareModel.activityId=0,shareModel.id=(new Date).getTime()+"-"+t.loggedInUser,shareModel.feeling=e.feeling,shareModel.latitude=o,shareModel.longitude=i,shareModel.timestamp=(new Date).toLocaleDateString(),shareModel.author=n.get("user"),client.addShare(shareModel,function(e,t){if(e){var a=$("#activity-feedback");a.addClass("error-msg"),a.html("Something went wrong! Please try again later"),a.animate({opacity:1},500),a.css("display","block"),$("html").click(function(){a.css("display","none")}),console.log(e)}else{var a=$("#activity-feedback");a.removeClass("error-msg"),a.addClass("success-msg"),a.html("Thanks for sharing!"),a.animate({opacity:1},500),a.css("display","block"),console.log("share added"),$("html").click(function(){a.css("display","none")}),createMap.getData()}}))}var o,i;navigator.geolocation.getCurrentPosition(a,showError)},e.sendMessage=function(){var t=e.message;chat.messages[chat.selectedUser].currentUser.push(t),chat.addMessageToChat(chat.selectedUser);var a=document.getElementById("messages");a.value="",client.sendMessage(t,chat.selectedUser,function(e,t){e&&console.log(e),console.log(t)})},e.logout=function(){n.remove("user"),client.isAdmin=!1;var e=document.querySelector('button[id^="btnDelete_"]');null!==e&&(e.style.display="none"),localStorage.token=void 0,localStorage.isAvailable=void 0,localStorage.hash=void 0,localStorage.username=void 0,t.loggedInUser=null,a.path("/")},e.changeMap=function(){var e=event.target||event.srcElement||event.originalTarget;mapType.changeMapType(e.id)}};e.controller("MainController",["$scope","$rootScope","$location","$cookies",t])}(),function(){var e=angular.module("app"),t=function(e,t,a){a.loggedInUser=null,e.userRegister=function(){var t=new RegExp("^[a-zA-Z]*$");if(t.test(e.fname)&&t.test(e.lname)){var n=e.lname+""+e.fname,o=e.chatbox;o=o?!0:!1,client.register(e.lname,e.fname,n,e.password,o,function(t,o){t?console.log(t):(a.loggedInUser=n,client.login(n,e.password,function(e,t){location.href="/#/main"}))})}}};e.controller("RegisterController",["$scope","$location","$rootScope",t])}();var directives=angular.module("app");directives.directive("passwordToggle",["$compile",function(e){return{restrict:"A",scope:{},link:function(t,a,n){t.tgl=function(){a.attr("type","text"===a.attr("type")?"password":"text")};var o=angular.element('<a data-ng-click="tgl()">Toggle</a>');e(o)(t),a.wrap('<div class="password-toggle"/>').after(o)}}}]);var directives=angular.module("app");directives.directive("showtab",function(){return{link:function(e,t,a){t.click(function(e){e.preventDefault(),$(t).tab("show")})}}}),function(){"use strict";navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition,showError):showError(error)}();