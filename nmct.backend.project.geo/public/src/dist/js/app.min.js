function showErrorMsg(){jQuery(this).attr("data-popup-open");$('[data-popup="popup-1"]').fadeIn(350),$("#wrapper").toggleClass("toggled"),$("[data-popup-close]").on("click",function(e){var t=jQuery(this).attr("data-popup-close");$('[data-popup="'+t+'"]').fadeOut(350)})}function showPosition(e){var t=e.coords.latitude,n=e.coords.longitude,a={lat:t,lng:n};placeMarkerAndPanTo(a,map)}function placeMarkerAndPanTo(e,t){var n=new google.maps.Marker({position:e,map:t,draggable:!0});t.panTo(e);var a='<h1 class="iw-title">Your location!!</h1>',o=new google.maps.InfoWindow({content:a});n.addListener("click",function(){o.open(t,n)})}function showError(e){switch(e.code){case e.PERMISSION_DENIED:showErrorMsg();break;case e.POSITION_UNAVAILABLE:showErrorMsg();break;case e.TIMEOUT:showErrorMsg();break;case e.UNKNOWN_ERROR:showErrorMsg()}}var chat=function(){function e(e,n){if(void 0!==n&&null===document.getElementById(n)){var a=document.createElement("li"),o=document.createElement("div");o.setAttribute("class","chat-status"),a.appendChild(o),a.appendChild(document.createTextNode(n)),a.id=n,a.setAttribute("class","list-group-item online-users");var r=document.getElementById("users");r.appendChild(a),i[n]={currentUser:[],chatPartner:[]},t()}}function t(){var e=document.getElementsByClassName("online-users"),t=document.getElementsByClassName("sent-message")[0],a=document.getElementsByClassName("received-message")[0],o=document.getElementById("btn-send");(""===chat.selectedUser||"undefined"==typeof chat.selectedUser||null===chat.selectedUser)&&o.setAttribute("disabled",!0);for(var i=0,r=e.length;r>i;i++){var s=i;!function(i){e[i].addEventListener("click",function(){chat.selectedUser=e[i].id,$(this).parent().children().removeClass("active"),$(this).addClass("active"),o.removeAttribute("disabled"),t.innerHTML="",a.innerHTML="",n(chat.selectedUser)})}(s)}}function n(e){var t=document.getElementsByClassName("sent-message")[0],n=document.getElementsByClassName("received-message")[0];t.innerHTML="",n.innerHTML="";for(var a=0,o=i[e].currentUser.length;o>a;a++){var r=document.createElement("div");r.setAttribute("class","sent-message-box"),r.innerHTML=i[e].currentUser[a],t.appendChild(r)}for(var a=0,o=i[e].chatPartner.length;o>a;a++){var r=document.createElement("div");r.setAttribute("class","received-message-box"),r.innerHTML=i[e].chatPartner[a],n.appendChild(r)}}function a(e,t){document.getElementById(t).remove()}var o,i=[];return{addUser:e,deleteUser:a,selectedUser:o,messages:i,addMessageToChat:n}}(),Sha1={};Sha1.hash=function(e){e=e.utf8Encode();var t=[1518500249,1859775393,2400959708,3395469782];e+=String.fromCharCode(128);for(var n=e.length/4+2,a=Math.ceil(n/16),o=new Array(a),i=0;a>i;i++){o[i]=new Array(16);for(var r=0;16>r;r++)o[i][r]=e.charCodeAt(64*i+4*r)<<24|e.charCodeAt(64*i+4*r+1)<<16|e.charCodeAt(64*i+4*r+2)<<8|e.charCodeAt(64*i+4*r+3)}o[a-1][14]=8*(e.length-1)/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=8*(e.length-1)&4294967295;for(var s,l,c,d,u,g=1732584193,p=4023233417,m=2562383102,h=271733878,f=3285377520,v=new Array(80),i=0;a>i;i++){for(var y=0;16>y;y++)v[y]=o[i][y];for(var y=16;80>y;y++)v[y]=Sha1.ROTL(v[y-3]^v[y-8]^v[y-14]^v[y-16],1);s=g,l=p,c=m,d=h,u=f;for(var y=0;80>y;y++){var S=Math.floor(y/20),b=Sha1.ROTL(s,5)+Sha1.f(S,l,c,d)+u+t[S]+v[y]&4294967295;u=d,d=c,c=Sha1.ROTL(l,30),l=s,s=b}g=g+s&4294967295,p=p+l&4294967295,m=m+c&4294967295,h=h+d&4294967295,f=f+u&4294967295}return Sha1.toHexStr(g)+Sha1.toHexStr(p)+Sha1.toHexStr(m)+Sha1.toHexStr(h)+Sha1.toHexStr(f)},Sha1.f=function(e,t,n,a){switch(e){case 0:return t&n^~t&a;case 1:return t^n^a;case 2:return t&n^t&a^n&a;case 3:return t^n^a}},Sha1.ROTL=function(e,t){return e<<t|e>>>32-t},Sha1.toHexStr=function(e){for(var t,n="",a=7;a>=0;a--)t=e>>>4*a&15,n+=t.toString(16);return n},"undefined"==typeof String.prototype.utf8Encode&&(String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this))}),"undefined"==typeof String.prototype.utf8Decode&&(String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this))}catch(e){return this}}),"undefined"!=typeof module&&module.exports&&(module.exports=Sha1),"function"==typeof define&&define.amd&&define([],function(){return Sha1});var client=function(){"use-strict";var e,t,n,a=function(n){void 0!==t&&t.disconnect(),t=io.connect(e?"?token="+e:"",{forceNew:!0}),t.on("time",function(e){console.log("- broadcast: "+e)}).on("register",function(e){console.log("- register")}).on("authenticated",function(){console.log("- authenticated")}).on("disconnect",function(){console.log("- disconnected")}).on("unauthorized",function(e){console.log("- unauthorized")}).on("addshare",function(e){createMap.addShareToMap(null,e)}).on("addactivity",function(e){createMap.addActivityToMap(null,e)}).on("deleteactivity",function(e){createMap.deleteActivityFromMap(null,e)}).on("newuser",function(e){localStorage.isAvailable&&(chat.addUser(null,e),console.log("- new user: "+e))}).on("users",function(e){if(localStorage.isAvailable)for(var t=0,n=e.length;n>t;t++)chat.addUser(null,e[t])}).on("deleteuser",function(e){localStorage.isAvailable&&(chat.deleteUser(null,e.username),console.log("- delete user: "+e.username))}).on("message",function(e){chat.messages[e.username].chatPartner.push(e.message),chat.addMessageToChat(e.username),console.log("- message: "+e.message)}).on("challenge",function(e){console.log(e)}).on("error",function(e){console.log("- Socket error: "+e)}),client.isAdmin=n.isAdmin,n.isAvailable&&(t.emit("newuser",n),t.emit("users",null))},o=function(e){i("anonymous",Sha1.hash("123"),e)},i=function(t,n,o){$.ajax({type:"POST",contentType:"text/html; charset=UTF-8",data:{username:t,password:n},url:"../login"}).done(function(t){t.error?o(t.error,null):t.token?(e=t.token,localStorage.token=e,localStorage.isAvailable=t.user.isAvailable,localStorage.hash=t.user.password,localStorage.username=t.user.username,a(t.user),o(null,t.user)):o("Unhandeld error",null)})},r=function(e,t,n){i(e,Sha1.hash(t.toString()),n)},s=function(e,t,n){i(e,t,n)};return register=function(n,a,o,i,r,s){var l={id:o,name:n,firstname:a,username:o,password:Sha1.hash(i+""),isAvailable:r};null===l.id||""===l.id?s("Error: 'id' is missing",null):(t.emit("register",{error:null,user:l,token:null===e?localStorage.token:e}),s(null,l))},getAllGeneric=function(e,n){t.on(e,function(t){t?n(null,t):n("no "+e+" found",null)}),t.emit(e,null)},addShare=function(n,a){if("anonymous"===localStorage.username)a("Unauthorized",null);else{var o={error:null,share:n,token:null===e?localStorage.token:e};null===n.id||""===n.id?a("Error: 'id' is missing",null):(t.emit("addshare",o),a(null,o))}},addActivity=function(n,a){if("anonymous"===localStorage.username)a("Unauthorized",null);else{var o={error:null,activity:n,token:null===e?localStorage.token:e};null===n.id||""===n.id?a("Error: 'id' is missing",null):(t.emit("addactivity",o),a(null,o))}},sendMessage=function(e,n,a){t.emit("message",{message:e,username:n}),a(null,"message send")},deleteActivity=function(n,a){n?(t.emit("deleteactivity",{error:null,activityId:n,token:null===e?localStorage.token:e}),a(null,n)):a("no 'id' found in activityId",null)},{login:r,rememberMeLogin:s,register:register,connectAnonymous:o,getAllGeneric:getAllGeneric,addShare:addShare,addActivity:addActivity,deleteActivity:deleteActivity,sendMessage:sendMessage,isAdmin:n}}(),markers=[],contentString="",previousShareId="",map,createMap=function(){"use strict";function e(e,t,n){contentString='<div id="iw-container" class="container"><div class="row"><h1 class="iw-title">'+e.activityName+'</h1><div class="col-sm-5"><div class="list-group"><button id="btn'+e.id+'_happy" value="happy" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/happy@xs.png" alt="happy"><span class="feeling-text">Happy </span> <span class="badge share-count" id="badge_'+e.id+'_happy">'+n.happy+'</span></button><button id="btn'+e.id+'_excited" value="excited" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/excited@xs.png" alt="excited"><span class="feeling-text">Excited</span> <span class="badge share-count" id="badge_'+e.id+'_excited">'+n.excited+'</span></button><button id="btn'+e.id+'_tender" value="tender" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/tender@xs.png" alt="tender"><span class="feeling-text">Tender</span><span class="badge share-count" id="badge_'+e.id+'_tender">'+n.tender+'</span></button></div></div><div class="col-sm-5"><div class="list-group feelings-right"><button id="btn'+e.id+'_scared" value="scared" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/scared@xs.png" alt="scared"><span class="feeling-text">Scared</span><span class="badge share-count" id="badge_'+e.id+'_scared">'+n.scared+'</span></button><button id="btn'+e.id+'_sad" value="sad" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/sad@xs.png" alt="sad"><span class="feeling-text">Sad</span><span class="badge share-count" id="badge_'+e.id+'_sad">'+n.sad+'</span></button><button id="btn'+e.id+'_angry" value="angry" class="list-group-item feeling-btn"><img class="feeling-icon" src="./images/angry@xs.png" alt="angry"><span class="feeling-text">Angry</span><span class="badge share-count" id="badge_'+e.id+'_angry">'+n.angry+'</span></button></div></div></div><div class="alert alert-success alert-dismissable " id="feedback" role="alert"><span id="feedback-msg"></span><button class="close-alert">&times;</button></div><button ng-show="isAdmin" id="btnDelete_'+e.id+'" class="btn btn-danger" >Delete</button></div>';var a=new google.maps.InfoWindow({content:contentString});t.addListener("click",function(){a.open(map,t)}),google.maps.event.addListener(a,"domready",function(){for(var t=["happy","excited","tender","sad","scared","angry"],n=0,a=t.length;a>n;n++)!function(n){document.getElementById("btn"+e.id+"_"+t[n]).addEventListener("click",function(a){c(t[n],e)})}(n);var o=document.querySelector('button[id^="btnDelete_'+e.id+'"]');o.style.display=client.isAdmin?"block":"none",document.getElementById("btnDelete_"+e.id).addEventListener("click",function(t){client.deleteActivity(e.id,function(e,t){console.log("delete activity")})}),l(localStorage.username,e.id,function(e,t){e&&console.log(e)})})}var t=function(e){var t=document.getElementById(e),n={center:{lat:50.824683,lng:3.25141},zoom:8,mapTypeControl:!1,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(t,n)},n=function(){client.connectAnonymous(function(e,t){e?console.log(e):a()})},a=function(){client.getAllGeneric("signedshares",function(e,t){e&&console.log(e);for(var n=0,a=t.length;a>n;n++){var o=t[n],i=o.activityId+"";void 0===allSignedShares[i]&&(allSignedShares[i]=[]),allSignedShares[i].push(o)}client.getAllGeneric("activities",function(e,t){if(e)console.log(e);else for(var n=0,a=t.length;a>n;n++)r(null,t[n])})}),client.getAllGeneric("unsignedshares",function(e,t){e&&console.log(e);for(var n=0,a=t.length;a>n;n++){var o=t[n].author;void 0===allUnsignedShares[o]&&(allUnsignedShares[o]=[]),allUnsignedShares[o].push(t[n])}for(var n=0,a=t.length;a>n;n++)i(null,t[n])})},o=function(e,t){if(0==t.activityId)i(e,t);else if(t.id!==previousShareId){previousShareId=t.id;var n=(markers[t.activityId],document.getElementById("badge_"+t.activityId+"_"+t.feeling)),a=parseInt(n.innerHTML);n.innerHTML=isNaN(a)||0===a?1:++a}},i=function(e,t){var n=new google.maps.Marker({position:{lat:t.latitude,lng:t.longitude},icon:"../images/"+t.feeling+"-pin.png",map:map}),a=allUnsignedShares[t.author],o='<div id="iw-container" class="container"><div class="row"><h1 class="iw-title">'+t.author+'</h1><canvas id="feelings-chart"></canvas></div></div>',i=new google.maps.InfoWindow({content:o}),r={happy:0,sad:0,excited:0,tender:0,angry:0,scared:0};if(void 0!==a)for(var s=0,l=a.length;l>s;s++)r[a[s].feeling]++;var c={labels:["Happy","Excited","Tender","Scared","Sad","Angry"],datasets:[{label:"Feelings",fillColor:"rgba(220,220,220,0.2)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:[r.happy,r.excited,r.tender,r.scared,r.sad,r.angry]}]};n.addListener("click",function(){i.open(map,n);var e=document.getElementById("feelings-chart").getContext("2d");new Chart(e).Line(c)})},r=function(t,n){var a=new google.maps.Marker({position:{lat:n.latitude,lng:n.longitude},icon:"../images/activity_pin@xs.png",map:map});a.set("id",n.id),markers[n.id]=a;var o={happy:0,sad:0,excited:0,tender:0,angry:0,scared:0},i=allSignedShares[n.id];if(void 0!==i)for(var r=0,s=i.length;s>r;r++)o[i[r].feeling]++;e(n,a,o)},s=function(e,t){e&&console.log(e);var n=markers[t];n.setMap(null)},l=function(e,t,n){var a=allSignedShares[t];("undefined"===a||a.length<=0)&&n(null,null);for(var o=0,i=a.length;i>o;o++)a[o].author===e&&n(null,a[o]);n(null,null)},c=function(e,t){function n(t){a=t.coords.latitude,o=t.coords.longitude,shareModel.id=(new Date).getTime()+"-"+localStorage.username,shareModel.feeling=e,shareModel.latitude=a,shareModel.longitude=o,shareModel.timestamp=(new Date).toLocaleDateString(),shareModel.author=localStorage.username,shareModel.activityId=i,client.addShare(shareModel,function(e,t){var n=$("#iw-container"),a=$("#feedback"),o=$("#feedback-msg");n.animate({height:237},500),a.css("display","block");var i=$(".close-alert");e?(console.log(e),a.addClass("share-failed"),o.html("An error occured!"),$(".share-failed").animate({opacity:1},750),i.click(function(){$(".share-failed").animate({opacity:0},750),n.animate({height:205},500)})):(console.log("share added"),a.removeClass("share-failed"),a.addClass(" share-success"),o.html("Thanks for sharing!"),$(".share-success").animate({opacity:1},750),i.click(function(){$(".share-success").animate({opacity:0},750),n.animate({height:205},500)}))})}var a,o,i=t.id;navigator.geolocation.getCurrentPosition(n,showError)};return{initialize:t,addShareToMap:o,addUnsignedShareToMap:i,addActivityToMap:r,deleteActivityFromMap:s,getData:n}}(),mapType=function(){"use strict";return{changeMapType:function(e){switch(e){case"hybrid":map.setMapTypeId(google.maps.MapTypeId.HYBRID);break;case"roadmap":map.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case"satellite":map.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case"terrain":map.setMapTypeId(google.maps.MapTypeId.TERRAIN);break;default:map.setMapTypeId(google.maps.MapTypeId.ROADMAP)}}}}(),activityModel={id:"",activityName:"",author:"",feeling:"",latitude:"",longitude:"",timestamp:""},shareModel={id:"",ShareName:"",author:"",feeling:"",latitude:"",longitude:"",timestamp:"",activityId:""},allSignedShares=[[]],allUnsignedShares=[];!function(){google.maps.event.addDomListener(window,"load",createMap.initialize("map-canvas")),google.maps.event.addDomListener(window,"resize",function(){var e=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(e)});var e=angular.module("app",["ngRoute","ngCookies"]);e.config(["$logProvider","$routeProvider",function(e,t){e.debugEnabled(!0),t.when("/",{controller:"LoginController",controllerAs:"login",templateUrl:"./templates/login.html"}).when("/register",{controller:"RegisterController",controllerAs:"register",templateUrl:"./templates/register.html"}).when("/main",{controller:"MainController",controllerAs:"main",templateUrl:"./templates/main.html",resolve:{addUsers:function(){}}}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$cookies",function(e,t,n){e.$on("$routeChangeStart",function(n,a,o){e.loggedInUser||"./templates/main.html"===a.templateUrl&&t.path("/")})}]),createMap.getData()}(),function(){var e=angular.module("app"),t=function(e){};e.controller("HomeController",["$scope",t])}(),function(){var e=angular.module("app"),t=function(e,t,n,a){e.isAdmin=void 0!=localStorage.isAmin&&localStorage.isAdmin?!0:!1,e.userLogin=function(){n.loggedInUser=null,client.login(e.username,e.password,function(t,o){t?console.log(t):(a.put("user",e.username),n.loggedInUser=e.username,localStorage.username=e.username,location.href="/#/main")})}};e.controller("LoginController",["$scope","$location","$rootScope","$cookies",t])}(),function(){var e=angular.module("app"),t=function(e,t,n,a){for(var o=["happy","excited","tender","sad","scared","angry"],i=0,r=o.length;r>i;i++)!function(t){$("#"+o[t]).bind("click",function(n){o[t]==e.feeling?$("#"+e.feeling).addClass("active"):$("#"+e.feeling).removeClass("active")})}(i);localStorage.isAvailable||(document.getElementById("chat").innerHTML='<div class="container"><div class="row"><h2 class="headline">No chatbox available</h2></div></div>'),e.addActivityDb=function(){function n(n){i=n.coords.latitude,r=n.coords.longitude,e.activityName?(activityModel.id=(new Date).getTime()+"-"+a.get("user"),activityModel.activityName=e.activityName,activityModel.feeling=e.feeling,activityModel.latitude=i,activityModel.longitude=r,activityModel.timestamp=(new Date).toLocaleDateString(),activityModel.author=a.get("user"),client.addActivity(activityModel,function(e,t){console.log("activity added")})):(shareModel.activityId=0,shareModel.id=(new Date).getTime()+"-"+t.loggedInUser,shareModel.feeling=e.feeling,shareModel.latitude=i,shareModel.longitude=r,shareModel.timestamp=(new Date).toLocaleDateString(),shareModel.author=a.get("user"),client.addShare(shareModel,function(e,t){console.log("share added")}))}var o=new RegExp("^[a-zA-Z\\s]*$");if(o.test(e.activityName)){var i,r;navigator.geolocation.getCurrentPosition(n,showError)}},e.sendMessage=function(){var t=e.message;chat.messages[chat.selectedUser].currentUser.push(t),chat.addMessageToChat(chat.selectedUser);var n=document.getElementById("messages");n.value="",client.sendMessage(t,chat.selectedUser,function(e,t){e&&console.log(e),console.log(t)})},e.logout=function(){a.remove("user"),t.loggedInUser=null,n.path("/")},e.changeMap=function(){var e=event.target||event.srcElement||event.originalTarget;mapType.changeMapType(e.id)}};e.controller("MainController",["$scope","$rootScope","$location","$cookies",t])}(),function(){var e=angular.module("app"),t=function(e,t,n){n.loggedInUser=null,$("#password").hideShowPassword({show:!1,innerToggle:!0,toggleClass:"my-toggle-class",hideToggleUntil:"focus",touchSupport:Modernizr.touch}),e.userRegister=function(){var t=new RegExp("^[a-zA-Z]*$");if(t.test(e.fname)&&t.test(e.lname)){var a=e.lname+""+e.fname,o=e.chatbox;o=o?!0:!1,client.register(e.lname,e.fname,a,e.password,o,function(t,o){t?console.log(t):(n.loggedInUser=a,client.login(a,e.password,function(e,t){location.href="/#/main"}))})}}};e.controller("RegisterController",["$scope","$location","$rootScope",t])}();var directives=angular.module("app");directives.directive("showtab",function(){return{link:function(e,t,n){t.click(function(e){e.preventDefault(),$(t).tab("show")})}}}),function(){"use strict";navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition,showError):showError(error)}();